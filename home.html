<!DOCTYPE html>
<html>

<head>
  <style>
    .title {
      background-color: rgb(0, 222, 11);
      color: rgb(0, 0, 0);
      border: 2px solid black;
      margin: 20px;
      padding: 20px;
    }
  </style>
</head>

<script>
  function searchMovie() {
    titleElement = document.getElementById("title");
    title = titleElement.value;
    // title = title.replace(" ", "+");
    fetch(`http://localhost:8080/movie/${title}`, {
      method: 'GET',
    })
      .then(res => res.json())
      .then((data) => {
        results = document.getElementById("resultsText");
        if (!data.url) {
          results.innerText = "No URL found";
        } else {
          results.innerText = data.url;
        }
        results.style.display = "block";

        updatePlaylists();
        document.getElementById("playlistFeatures").removeAttribute("hidden");
        sessionStorage.metadataId = data.metadataId;
      })
      .catch((error) => {
        results = document.getElementById("resultsText");
        results.innerText = error.message;
        results.style.display = "block";
      });
  }

  function searchTvShow() {
    titleElement = document.getElementById("title");
    title = titleElement.value;
    title = title.replace(" ", "+");
    fetch(`http://localhost:8080/tvshow/${title}`, {
      method: 'GET',
    })
      .then(res => res.json())
      .then((data) => {
        seasons = document.getElementById("seasonNum");
        while (seasons.options.length > 1) {
          seasons.remove(1);
        }

        for (let i = 0; i < data.length; i++) {
          var option = document.createElement("option");
          option.text = `${i + 1}`;
          option.value = `${i + 1}`;
          seasons.add(option);
        }
        sessionStorage.currShow = JSON.stringify(data);
        document.getElementById("episodeNum").style.display = "none";
        seasons.style.display = "block";
      })
      .catch((error) => {
        results = document.getElementById("resultsText");
        results.innerText = error.message;
        results.style.display = "block";
      });
  }

  function updateEpisodes() {
    seasonNum = document.getElementById("seasonNum").value;
    if (seasonNum === "-") {
      return;
    }

    data = JSON.parse(sessionStorage.currShow);
    episodes = document.getElementById("episodeNum");
    while (episodes.options.length > 1) {
      episodes.remove(1);
    }

    let anyLinkFound = false;
    for (let i = 0; i < data[seasonNum - 1].episodes.length; i++) {
      let url = data[seasonNum - 1].episodes[i].streamingInfo.us.netflix[0].watchLink;
      if (url) {
        let option = document.createElement("option");
        option.value = `${url}`;
        option.text = `${i + 1}`;
        episodes.add(option);
        anyLinkFound = true;
      }
    }

    if (anyLinkFound) {
      episodes.style.display = "block";
    } else {
      results = document.getElementById("resultsText");
      results.innerText = "No URL found";
      results.style.display = "block";
    }
  }

  function searchEpisode() {
    seasonNum = document.getElementById("seasonNum").value;
    selectedIndex = document.getElementById("episodeNum").selectedIndex;
    episodeNum = document.getElementById("episodeNum").options[selectedIndex].text;
    episodeUrl = document.getElementById("episodeNum").value;
    data = JSON.parse(sessionStorage.currShow);

    titleElement = document.getElementById("title");
    title = titleElement.value;
    title = title.replace(" ", "+");
    fetch(`http://localhost:8080/episode?title=${title}&seasonNum=${seasonNum}&episodeNum=${episodeNum}&episodeURL=${episodeUrl}`, {
      method: 'GET',
    })
      .then(res => res.json())
      .then((data) => {
        results = document.getElementById("resultsText");
        results.innerText = data.url;
        results.style.display = "block";

        updatePlaylists();
        document.getElementById("playlistFeatures").removeAttribute("hidden");
        sessionStorage.metadataId = data.metadataId;
      })
      .catch((error) => {
        results = document.getElementById("resultsText");
        results.innerText = error.message;
        results.style.display = "block";
      });
  }

  function enterSearch(event) {
    if (event.keyCode === 13) {
      if (document.getElementById("tvOrMovie").value === "Movie") {
        searchMovie();
      } else {
        searchTvShow();
      }
    }
  }

  function toggle() {
    switchValue = document.getElementById("tvOrMovie").value;
    document.getElementById("searchButton").innerText = `Search ${switchValue}`;

    if (switchValue === "TV Show") {
      document.getElementById('searchButton').setAttribute('onclick', 'searchTvShow()')
    } else {
      document.getElementById("seasonNum").style.display = "none";
      document.getElementById("episodeNum").style.display = "none";
      document.getElementById('searchButton').setAttribute('onclick', 'searchMovie()')
    }
    document.getElementById('title').value = "";
    document.getElementById("playlistFeatures").setAttribute("hidden", "hidden");
  }

  function openPLCreate() {
    document.getElementById("playlistManagementSection").removeAttribute("hidden");
    document.getElementById("openPLCreate").style.display = "none";
    document.getElementById("email").value = '';
    document.getElementById("playlistName").value = '';
  }

  function createPlaylist() {
    email = document.getElementById("email").value;
    name = document.getElementById("playlistName").value;
    if (email === "") {
      alert("Email field cannot be blank");
    } else if (name === "") {
      alert("Name field cannot be blank");
    } else {
      document.getElementById("openPLCreate").style.display = "block";
      document.getElementById("playlistManagementSection").setAttribute("hidden", "hidden");
      email = document.getElementById("email").value;
      playlistName = document.getElementById("playlistName").value;

      fetch(`http://localhost:8080/createPlaylist?email=${email}&name=${playlistName}`, {
        method: 'GET',
      })
        .then(res => res.json())
        .then((data) => {
          results = document.getElementById("playlistActionResults");
          results.innerText = data.result;
          results.style.display = "block";

          if (!document.getElementById("playlistFeatures").hasAttribute("hidden")) {
            updatePlaylists();
          }
        })
        .catch((error) => {
          results = document.getElementById("playlistActionResults");
          results.innerText = error.message;
          results.style.display = "block";
        });
    }
  }

  function updatePlaylists() {
    fetch(`http://localhost:8080/getPlaylists/`, {
      method: 'GET',
    })
      .then(res => res.json())
      .then((data) => {
        playlists = document.getElementById("playlistSelect");
        while (playlists.options.length > 1) {
          playlists.remove(1);
        }

        if (data.code === 1) {
          for (let i = 0; i < data.playlistInfo.length; i++) {
            var option = document.createElement("option");
            option.text = `${data.playlistInfo[i].userDefinedName}`;
            option.value = `${data.playlistInfo[i].playlistId}`;
            playlists.add(option);
          }
        } else {
          results = document.getElementById("playlistActionResults");
          results.innerText = "unable to populate playlists dropdown";
          results.style.display = "block";
        }
      })
      .catch((error) => {
        results = document.getElementById("playlistActionResults");
        results.innerText = error.message;
        results.style.display = "block";
      });
  }

  function addToPlaylist() {
    playlistId = document.getElementById("playlistSelect").value;

    fetch(`http://localhost:8080/addToPlaylist?playlistId=${playlistId}&metadataId=${sessionStorage.metadataId}`, {
      method: 'GET',
    })
      .then(res => res.json())
      .then((data) => {
        results = document.getElementById("playlistActionResults");
        results.innerText = data.message;
        results.style.display = "block";
      })
      .catch((error) => {
        results = document.getElementById("playlistActionResults");
        results.innerText = error.message;
        results.style.display = "block";
      });
  }

</script>

<body>

  <div id="Header" class="title">
    <h2>Streamlist</h2>
    <p>name is a work in progress and not very good, be nice</p>
  </div>

  <div>
    <input id="title" type="text" onkeypress="enterSearch(event)" placeholder="Search Name...">

    <button id="searchButton" type="button" onclick="searchMovie()">Search Movie</button>

    <select name="tvOrMovie" id="tvOrMovie" data-role="slider" onchange="toggle()">
      <option value="Movie">Movie</option>
      <option value="TV Show">TV Show</option>
    </select>

  </div>

  <div>
    <select name="seasonNum" id="seasonNum" data-role="slider" onchange="updateEpisodes()" style='display: none'>
      <option value="-" id="nullSeason">Choose a Season</option>
    </select>

    <select name="episodeNum" id="episodeNum" data-role="slider" onchange="searchEpisode()" style='display: none'>
      <option value="-" id="nullEpisode">Choose an Episode</option>
    </select>
  </div>

  <button id="openPLCreate" type="button" onclick="openPLCreate()">Open Playlist Management Section</button>
  <div id="playlistManagementSection" hidden="hidden">
    Enter email: <input id="email" type="text" placeholder="Enter email...">
    Enter playlist name: <input id="playlistName" placeholder="Enter playlist name">
    <button id="createPlaylist" type="button" onclick="createPlaylist()">Create Playlist</button>
  </div>

  <p id="resultsText" style='display: none'>Test</p>

  <!--TODO:
        3. give a pop up window saying that you have to select a playlist when addToPlaylist is clicked without one selected
        4. delete playlist button under playlist management section, open with separate button and fetch playlist names when that happens to populate new dropdown
          a. ask for confirmation when you click delete
  -->
  <div id="playlistFeatures" hidden="hidden">
    <select name="playlistSelect" id="playlistSelect" data-role="slider">
      <option value="-" id="nullPlaylist">Select a Playlist</option>
    </select>
    <button id="addToPlaylist" type="button" onclick="addToPlaylist()">Add to Playlist</button>
  </div>

  <p id="playlistActionResults" style='display: none'>Test</p>

</body>

</html>